#!/usr/bin/env bash

set -e
set -o pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
. "${SCRIPT_DIR}"/common

DIRECTORY="${1}"; shift
if [[ -z "${DIRECTORY}" ]]; then
  echo 'DIRECTORY is required.' 2>&1
  exit 1
fi

docker_command=(docker run)
if [[ -t 0 ]]; then
  docker_command+=(--tty)
  docker_command+=(--env TERM="${TERM}")
fi
docker_command+=(--interactive)
if [[ -x "${DIRECTORY}/extra-docker-args" ]]; then
  docker_command+=($("${DIRECTORY}"/extra-docker-args))
fi
while [[ "${1}" == '--dockerArg' ]]; do
  shift
  docker_command+=("${1}")
  shift
done
docker_command+=(--hostname=$(getDockerImageName "${DIRECTORY}").${DNS_DOMAIN})
docker_command+=("$(getTaggedDockerImageName "${DIRECTORY}")")
docker_command+=("${@}")

echo "docker_command: ${docker_command[@]}"
if [[ -t 0 ]]; then
  exec "${docker_command[@]}"
else
  exec "${docker_command[@]}" <&0
fi

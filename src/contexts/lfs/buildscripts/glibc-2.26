#!/usr/bin/env bash

# SBUS: 0

set -o errexit
set -o errtrace
set -o pipefail
set -o nounset

# FIXME: This is duplicated with the lfs-bootstrap glibc build.
# NOTE: This should no longer be necessary in a newer version of glibc:
#       https://sourceware.org/git/gitweb.cgi?p=glibc.git;h=ae65d4f3c3995279ca458c460ebf8bab1885fa03
declare -r CFLAGS_ARR=($CFLAGS)
CFLAGS=''
for flag in "${CFLAGS_ARR[@]}"; do
  if [[ "$flag" == '-Os' ]]; then
    flag='-O2'
  fi
  if [[ -z "$CFLAGS" ]]; then
    CFLAGS="$flag"
  else
    CFLAGS+=" $flag"
  fi
done
CXXFLAGS="$CFLAGS"

# TODO: Comment some.

patch --forward --strip=1 --input="$SOURCES"/glibc-2.26-fhs-1.patch

ln --symbolic --force --verbose /tools/lib/gcc /usr/lib

MACHINE="$(uname --machine)"; readonly MACHINE
GCC_INCDIR=/usr/lib/gcc/$MACHINE-pc-linux-gnu/7.2.0/include
case "$MACHINE" in
  i?86)   ln --symbolic --force --verbose ld-linux.so.2 /lib/ld-lsb.so.3 ;;
  x86_64) ln --symbolic --force --verbose ../lib/ld-linux-x86-64.so.2 /lib64
          ln --symbolic --force --verbose ../lib/ld-linux-x86-64.so.2 /lib64/ld-lsb-x86-64.so.3
  ;;
esac

mkdir -v build
cd       build

CC="gcc -isystem $GCC_INCDIR -isystem /usr/include" \
../configure --prefix=/usr                          \
             --disable-werror                       \
             --enable-kernel=3.2                    \
             --enable-stack-protector=strong        \
             libc_cv_slibdir=/lib
unset GCC_INCDIR

make

make check
touch /etc/ld.so.conf
sed '/test-installation/s@$(PERL)@echo not running@' -i ../Makefile
make install

cp -v ../nscd/nscd.conf /etc/nscd.conf
mkdir -pv /var/cache/nscd

install -v -Dm644 ../nscd/nscd.tmpfiles /usr/lib/tmpfiles.d/nscd.conf
install -v -Dm644 ../nscd/nscd.service  /lib/systemd/system/nscd.service

mkdir -pv /usr/lib/locale
localedef -i cs_CZ -f UTF-8 cs_CZ.UTF-8
localedef -i de_DE -f ISO-8859-1 de_DE
localedef -i de_DE@euro -f ISO-8859-15 de_DE@euro
localedef -i de_DE -f UTF-8 de_DE.UTF-8
localedef -i en_GB -f UTF-8 en_GB.UTF-8
localedef -i en_HK -f ISO-8859-1 en_HK
localedef -i en_PH -f ISO-8859-1 en_PH
localedef -i en_US -f ISO-8859-1 en_US
localedef -i en_US -f UTF-8 en_US.UTF-8
localedef -i es_MX -f ISO-8859-1 es_MX
localedef -i fa_IR -f UTF-8 fa_IR
localedef -i fr_FR -f ISO-8859-1 fr_FR
localedef -i fr_FR@euro -f ISO-8859-15 fr_FR@euro
localedef -i fr_FR -f UTF-8 fr_FR.UTF-8
localedef -i it_IT -f ISO-8859-1 it_IT
localedef -i it_IT -f UTF-8 it_IT.UTF-8
localedef -i ja_JP -f EUC-JP ja_JP
localedef -i ru_RU -f KOI8-R ru_RU.KOI8-R
localedef -i ru_RU -f UTF-8 ru_RU.UTF-8
localedef -i tr_TR -f UTF-8 tr_TR.UTF-8
localedef -i zh_CN -f GB18030 zh_CN.GB18030

make localedata/install-locales
